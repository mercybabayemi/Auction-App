{% extends "base.html" %}

{% block title %}{{ auction.item_title }} - Auction Detail{% endblock %}

{% block content %}
<div class="auction-detail-container">

    <div class="auction-header">
        <h1>{{ auction.item_title }}</h1>
        <div class="auction-meta">
            <span class="status-badge {{ auction.status.lower() }}">{{ auction.status }}</span>
            <span class="auction-id">#{{ auction.id|truncate(8, True, '') }}</span>
        </div>
    </div>

    <div class="auction-content">

        <!-- Image Gallery -->
        <div class="image-gallery">
            <div class="main-image">
                {%  if auction.image_urls|length > 0 %}
                    <img src="{{ auction.image_urls[0] | cld_thumb(500, 400) }}" alt="{{ auction.item_title }}" id="main-auction-image">
                {% else %}
                <div class="no-image">
                    <i class="fas fa-image"></i>
                    <span>No Image Available</span>
                </div>
                {% endif %}
            </div>

            {% if auction.image_urls|length > 1 %}
            <div class="thumbnail-container">
                {% for url in auction.image_urls %}
                <div class="thumbnail {% if loop.first %}active{% endif %}" data-image-src="{{ url }}">
                    <img src="{{ url | cld_thumb(500, 400) }}" alt="{{ auction.item_title }} thumbnail {{ loop.index }}">
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <!-- Auction Details -->
        <div class="auction-details">
            <div class="detail-section">
                <h3>Description</h3>
                <p class="description">{{ auction.item_description }}</p>

                <div class="detail-item">
                    <span class="label">Condition:</span>
                    <span class="value">{{ auction.item_condition }}</span>
                </div>
                <div class="detail-item">
                    <span class="label">Category:</span>
                    <span class="value">{{ auction.category }}</span>
                </div>
                <div class="detail-item">
                    <span class="label">Seller:</span>
                    <span class="value">{{ auction.seller.username }}</span>
                </div>
            </div>

            {% if current_user and current_user.id == auction.seller.id %}
            <form method="POST" action="{{ url_for('auction_router.delete_auction', auction_id=auction.id) }}" onsubmit="return confirm('Are you sure?');">
                <button type="submit" class="btn btn-danger mt-3">
                    <i class="fas fa-trash"></i> Delete Auction
                </button>
            </form>
            {% endif %}

            <!-- Bidding Section -->
            <div class="bidding-section">
                <div class="price-display">
                    <div class="current-price">
                        <span class="label">Current Price:</span>
                        <span class="price" id="current-bid">${{ "%.2f"|format(auction.current_bid or auction.starting_bid) }}</span>
                    </div>
                    <div class="time-remaining">
                        <span class="label">Time Left:</span>
                        <span class="time" id="countdown-timer" data-endtime="{{ auction.end_time.isoformat() }}">
                            {{ auction.end_time|datetimeformat('%b %d, %Y %H:%M') }}
                        </span>
                    </div>
                </div>

                {% if auction.status == 'Active' %}
                    {% if current_user and current_user.is_active and current_user.id != auction.seller.id %}
                    <form id="bid-form">
                        <div class="form-group">
                            <label for="bid-amount">Your Bid ($)</label>
                            <input type="number" id="bid-amount" name="bid_amount"
                                   min="{{ (auction.current_bid or auction.starting_bid) + 0.01 }}" step="0.01" required>
                        </div>
                        <button type="submit" class="btn btn-bid">Place Bid</button>
                    </form>
                    {% elif not current_user %}
                    <p>You need to <a href="{{ url_for('auth_router.login') }}">log in</a> to place bids</p>
                    {% elif current_user.id == auction.seller.id %}
                    <p>You cannot bid on your own auction</p>
                    {% endif %}
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Bid History Section -->
    <div class="bid-history-section">
        <h2>Bid History</h2>
        {% if bids %}
        <div class="bid-history-list">
            {% for bid in bids %}
            <div class="bid-item {% if loop.first %}highest-bid{% endif %}">
                <span class="bidder">{% if bid.bidder.id == current_user.id %}You{% else %}{{ bid.bidder.username }}{% endif %}</span>
                <span class="amount">${{ "%.2f"|format(bid.bid_amount) }}</span>
                <span class="time">{{ bid.created_at|datetimeformat('%b %d, %H:%M') }}</span>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p>No bids yet. Be the first to bid!</p>
        {% endif %}
    </div>

</div>
{% endblock %}
